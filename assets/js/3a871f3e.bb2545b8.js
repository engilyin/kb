"use strict";(self.webpackChunkalex_ilin_kb=self.webpackChunkalex_ilin_kb||[]).push([[5885],{4582:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=t(4848),s=t(8453);const i={},o="Jenkins",l={id:"DevOps/jenkins",title:"Jenkins",description:"GitHub Webhook triggering",source:"@site/docs/DevOps/jenkins.md",sourceDirName:"DevOps",slug:"/DevOps/jenkins",permalink:"/kb/DevOps/jenkins",draft:!1,unlisted:!1,editUrl:"https://github.com/engilyin/kb/docs/DevOps/jenkins.md",tags:[],version:"current",lastUpdatedAt:175545902e4,frontMatter:{},sidebar:"defaultSidebar",previous:{title:"CI/CD",permalink:"/kb/DevOps/cicd"},next:{title:"Terraform",permalink:"/kb/DevOps/terraform"}},a={},c=[{value:"GitHub Webhook triggering",id:"github-webhook-triggering",level:2},{value:"Turn off triggering on scan",id:"turn-off-triggering-on-scan",level:2},{value:"Call cf command",id:"call-cf-command",level:2},{value:"Touch the endpoint",id:"touch-the-endpoint",level:2},{value:"Health checking",id:"health-checking",level:2},{value:"GitHub Web hook",id:"github-web-hook",level:2},{value:"On GitHub",id:"on-github",level:3},{value:"On Jenkins",id:"on-jenkins",level:3},{value:"On the project folder",id:"on-the-project-folder",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"jenkins",children:"Jenkins"})}),"\n",(0,r.jsx)(n.h2,{id:"github-webhook-triggering",children:"GitHub Webhook triggering"}),"\n",(0,r.jsx)(n.h2,{id:"turn-off-triggering-on-scan",children:"Turn off triggering on scan"}),"\n",(0,r.jsxs)(n.p,{children:["If you need to re-scan the pipeline to get new branches by default it would triggering all available branches which is not desirable.\r\nTo turn it off you need to add the property strategy ",(0,r.jsx)(n.code,{children:"Suppress automatic SCM triggering"})," and set:\r\n",(0,r.jsx)(n.code,{children:"For matching branches suppress builds triggering by indexing(continue to honor webhooks)"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"suppress-triggering",src:t(6298).A+"",width:"855",height:"800"})}),"\n",(0,r.jsxs)(n.p,{children:["But be careful because it would affect the ",(0,r.jsx)(n.code,{children:"WebHooks"})," if you need to trigger build on ",(0,r.jsx)(n.code,{children:"main"})," branch you need to add it to the regex: ",(0,r.jsx)(n.code,{children:"^main$"})," so it would be triggered."]}),"\n",(0,r.jsx)(n.h2,{id:"call-cf-command",children:"Call cf command"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-groovy",children:'\r\n#!groovy\r\n\r\n\r\n\r\ndef login(url, org, space){\r\n\r\nwithCredentials([usernamePassword(credentialsId: env.CredsToUse, usernameVariable: \'uName\', passwordVariable: \'password\')]) {\r\n\tCONNECT = sh (\r\n\t\t\t\tscript: "cf login -a ${url} -u \\"${uName}\\" -p \\"${password}\\" -o ${org} -s ${space}",\r\n\t\t\t\treturnStatus: true\r\n\t\t\t)\r\n\tsh """\r\n\t\t${env.PCF_COMMAND}\r\n\t\t"""\r\n}\r\n}\r\n\r\nansiColor(\'xterm\') {\r\n\r\nnode {\r\n\ttimeout(time: 30, unit: \'MINUTES\') {\r\n\r\n\t\tstage(\'Preparation\') {\r\n\t\t\tenv.PATH = "/usr/sbin:$env.PATH"\r\n\t\t\tenv.PATH = "/home/jenkins/bin:$env.PATH"\r\n\t\t\tenv.PATH = "/apps/home/builder/bin:$env.PATH"\r\n\r\n\t\t\tenv.LANG = "en_US.UTF-8"\r\n\t\t\tenv.LC_ALL = "en_US.UTF-8"\r\n\t\t\tenv.LANGUAGE = "en_US.UTF-8"\r\n\r\n\t\t\tdef regionUrlFragment;\r\n\t\t\tswitch(params.gcpRegion){\r\n\t\t\t\tcase "us-central-1":\r\n\t\t\t\t\tregionUrlFragment = \'usc1\'\r\n\t\t\t\t\tbreak\r\n\t\t\t\tcase "us-west-1":\r\n\t\t\t\t\tregionUrlFragment = \'usw1\'\r\n\t\t\t\t\tbreak\r\n\t\t\t}\r\n\t\t\tenv.PCF_API =  params.pcfApiEndpoint\r\n\t\t\tenv.PCF_ORG = params.pcfOrg\r\n\t\t\tenv.PCF_SPACE = params.pcfSpace\r\n\t\t\tenv.PCF_APP = params.pcfApp\r\n\t\t\tenv.PCF_COMMAND = params.pcfCommand\r\n\t\t}\r\n\t\t// stage(\'Approve Route Changes\'){\r\n\t\t//   input \'Please approve ClareityIAM Route management in production\'\r\n\t\t// }\r\n\t\tstage(\'Exec\')\r\n\t\t{\r\n\t\t\t\tlogin(env.PCF_API, env.PCF_ORG, env.PCF_SPACE)\r\n\r\n\t\t}\r\n\r\n\t}\r\n}\r\n}\r\n\n'})}),"\n",(0,r.jsx)(n.h2,{id:"touch-the-endpoint",children:"Touch the endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-groovy",children:"    stage('Stage 2') {\r\n      steps {\r\n        timeout(time: 1, unit: 'MINUTES') {\r\n          waitUntil {\r\n            script {\r\n              echo 'This stage should succeed immediately if google.com is up, otherwise jenkins will retry until 1min runs out.'\r\n              def status = sh script: 'wget -q https://google.com -O /dev/null', returnStatus: true\r\n              return (status == 0)\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"health-checking",children:"Health checking"}),"\n",(0,r.jsxs)(n.p,{children:["On the cloud you may need to check liveness of the Jenkins node. The best would be to install ",(0,r.jsx)(n.code,{children:"Metrics"})," plugin and call:\r\n",(0,r.jsx)(n.code,{children:"/metrics/healthcheckOk"})," it should respond with ",(0,r.jsx)(n.code,{children:"200"})," and with no payload."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hsl",children:'resource "aws_lb_target_group" "tg_jenkins" {\r\n  name        = "tg-jenkins"\r\n  port        = 8080\r\n  protocol    = "HTTP"\r\n  vpc_id      = var.vpc_id\r\n  target_type = "ip"  # ECS Fargate requires "ip", for EC2 instances use "instance"\r\n\r\n  health_check {\r\n    path                = "/metrics/healthcheckOk"\r\n    interval            = 120\r\n    timeout             = 20\r\n    healthy_threshold   = 5\r\n    unhealthy_threshold = 4\r\n    matcher             = "200"\r\n  }\r\n\r\n\r\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"github-web-hook",children:"GitHub Web hook"}),"\n",(0,r.jsx)(n.h3,{id:"on-github",children:"On GitHub"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"add webhook"}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"application/json"})]}),"\n",(0,r.jsx)(n.li,{children:"add secret (random hard to guess token)"}),"\n",(0,r.jsx)(n.li,{children:"Use custom events: Push and Pull"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"and you need the personal access token for your jenkins user to access repos.\r\nYou can create your own personal access token in your account GitHub settings.\r\nToken should be registered with scopes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"admin:repo_hook"})," - for managing hooks (read, write and delete old ones)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"repo"})," - to see private repos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"repo:status"})," - to manipulate commit statuses"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"You may create 2 separate personal tokens with and without hook support"}),"\n",(0,r.jsx)(n.h3,{id:"on-jenkins",children:"On Jenkins"}),"\n",(0,r.jsx)(n.p,{children:"On the Configuration/System"}),"\n",(0,r.jsx)(n.p,{children:"You need 3 things:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Credential as username/password with personal token and your GitHub username\r\nThat would be used to access repo on the app folders"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The token with personal token which allow repo and repo_hook access\r\nThat would be used to allow access GitHub API on System settings"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Web Hook secret for repo"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Register new credential as token"}),"\n",(0,r.jsx)(n.li,{children:"??? not sure where is should be used or may be should be properly named. It is used to auth callback call"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"on-the-project-folder",children:"On the project folder"}),"\n",(0,r.jsx)(n.p,{children:"????"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},6298:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/suppress-triggering-df7a330b08d03ee87146c48680a92035.jpg"},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var r=t(6540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);