"use strict";(self.webpackChunkalex_ilin_kb=self.webpackChunkalex_ilin_kb||[]).push([[1358],{2729:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>i,default:()=>u,frontMatter:()=>c,metadata:()=>a,toc:()=>l});var s=n(4848),t=n(8453);const c={},i="AWS DB Migration Service",a={id:"Cloud/AWS/db-migration",title:"AWS DB Migration Service",description:"Creating the collector",source:"@site/docs/Cloud/AWS/db-migration.md",sourceDirName:"Cloud/AWS",slug:"/Cloud/AWS/db-migration",permalink:"/kb/Cloud/AWS/db-migration",draft:!1,unlisted:!1,editUrl:"https://github.com/engilyin/kb/docs/Cloud/AWS/db-migration.md",tags:[],version:"current",lastUpdatedAt:175545902e4,frontMatter:{},sidebar:"defaultSidebar",previous:{title:"AWS",permalink:"/kb/Cloud/AWS/"},next:{title:"EC2",permalink:"/kb/Cloud/AWS/ec2"}},o={},l=[{value:"Creating the collector",id:"creating-the-collector",level:2},{value:"Create the S3 bucket",id:"create-the-s3-bucket",level:3},{value:"Creating the Role",id:"creating-the-role",level:3},{value:"Creating the Linked Role",id:"creating-the-linked-role",level:3},{value:"Creating the collector",id:"creating-the-collector-1",level:3},{value:"Creating Instance Profile",id:"creating-instance-profile",level:2},{value:"Instance Profile",id:"instance-profile",level:3},{value:"Security group",id:"security-group",level:3},{value:"Data Providers",id:"data-providers",level:2},{value:"Creating the secrets for accessing DB",id:"creating-the-secrets-for-accessing-db",level:3},{value:"Accessing the secrets",id:"accessing-the-secrets",level:3},{value:"Used services",id:"used-services",level:2}];function d(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"aws-db-migration-service",children:"AWS DB Migration Service"})}),"\n",(0,s.jsx)(r.h2,{id:"creating-the-collector",children:"Creating the collector"}),"\n",(0,s.jsx)(r.h3,{id:"create-the-s3-bucket",children:"Create the S3 bucket"}),"\n",(0,s.jsx)(r.p,{children:"Just regular bucket in the same region where the DB is running."}),"\n",(0,s.jsxs)(r.p,{children:["Let's call it ",(0,s.jsx)(r.code,{children:"jumpbox-to-rds-db-migration"})]}),"\n",(0,s.jsx)(r.h3,{id:"creating-the-role",children:"Creating the Role"}),"\n",(0,s.jsx)(r.p,{children:"Create the custom policy to use for this Role:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n    "Version": "2012-10-17",\r\n    "Statement": [\r\n        {\r\n            "Effect": "Allow",\r\n            "Action": [\r\n                "s3:GetObject*",\r\n                "s3:GetBucket*",\r\n                "s3:List*",\r\n                "s3:DeleteObject*",\r\n                "s3:PutObject*"\r\n            ],\r\n            "Resource": [\r\n                "arn:aws:s3:::jumpbox-to-rds-db-migration",\r\n                "arn:aws:s3:::jumpbox-to-rds-db-migration/*"\r\n            ]\r\n        },\r\n        {\r\n            "Effect": "Allow",\r\n            "Action": [\r\n                "dms:DescribeFleetAdvisorCollectors",\r\n                "dms:ModifyFleetAdvisorCollectorStatuses",\r\n                "dms:UploadFileMetadataList"\r\n            ],\r\n            "Resource": "*"\r\n        }\r\n    ]\r\n}\n'})}),"\n",(0,s.jsxs)(r.p,{children:["Also later you can reuse this role to access the secret manager to retrieve the secrets for accessing the DB.\r\nSo create such policy ",(0,s.jsx)(r.code,{children:"AccessSecretManager"})]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "Version": "2012-10-17",\r\n  "Statement": [\r\n    {\r\n      "Sid": "AllowDMSSecretsManagerWithKMSRole",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "secretsmanager:DescribeSecret",\r\n        "secretsmanager:GetSecretValue"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:secretsmanager:us-east-1:<ACCOUNT-ID>:secret:*"\r\n      ]\r\n    },\r\n    {\r\n      "Sid": "KMS",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "kms:Encrypt",\r\n        "kms:ReEncryptFrom",\r\n        "kms:ReEncryptTo",\r\n        "kms:Decrypt"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:kms:us-east-1:<ACCOUNT-ID>:key/*"\r\n      ],\r\n      "Condition": {\r\n        "StringEquals": {\r\n          "kms:CallerAccount": "<ACCOUNT-ID>",\r\n          "kms:ViaService": [\r\n            "secretsmanager.us-east-1.amazonaws.com"\r\n          ],\r\n          "kms:EncryptionContext:SecretARN": [\r\n            "arn:aws:secretsmanager:us-east-1:<ACCOUNT-ID>:secret:*"\r\n          ]\r\n        }\r\n      }\r\n    },\r\n    {\r\n      "Sid": "KMSDescribeKey",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "kms:DescribeKey"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:kms:us-east-1:<ACCOUNT-ID>:key/*"\r\n      ],\r\n      "Condition": {\r\n        "StringEquals": {\r\n          "kms:CallerAccount": "<ACCOUNT-ID>",\r\n          "kms:ViaService": "secretsmanager.us-east-1.amazonaws.com"\r\n        }\r\n      }\r\n    },\r\n    {\r\n      "Sid": "KMSListAliases",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "kms:ListAliases"\r\n      ],\r\n      "Resource": "*"\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:"Trust policy should be"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "Version": "2012-10-17",\r\n  "Statement": [\r\n    {\r\n      "Effect": "Allow",\r\n      "Principal": {\r\n        "Service": [\r\n          "dms.amazonaws.com",\r\n          "dms-fleet-advisor.amazonaws.com"\r\n        ]\r\n      },\r\n      "Action": "sts:AssumeRole"\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"creating-the-linked-role",children:"Creating the Linked Role"}),"\n",(0,s.jsxs)(r.p,{children:["Just add the role ",(0,s.jsx)(r.code,{children:"AWSServiceRoleForDMSFleetAdvisor "})," with managed policy ",(0,s.jsx)(r.code,{children:"AWSDMSFleetAdvisorServiceRolePolicy"})]}),"\n",(0,s.jsx)(r.h3,{id:"creating-the-collector-1",children:"Creating the collector"}),"\n",(0,s.jsx)(r.p,{children:"Just name it add the S3 and role and it should be able to provision the collector"}),"\n",(0,s.jsx)(r.h2,{id:"creating-instance-profile",children:"Creating Instance Profile"}),"\n",(0,s.jsx)(r.h3,{id:"instance-profile",children:"Instance Profile"}),"\n",(0,s.jsx)(r.h3,{id:"security-group",children:"Security group"}),"\n",(0,s.jsxs)(r.p,{children:["You need ",(0,s.jsx)(r.code,{children:"dms-vpc-role"})," role with:"]}),"\n",(0,s.jsx)(r.p,{children:"Trust Relationship:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "Version": "2012-10-17",\r\n  "Statement": [\r\n    {\r\n      "Sid": "AWSDMSVPCPolicyTemplate",\r\n      "Effect": "Allow",\r\n      "Principal": {\r\n        "Service": "dms.amazonaws.com"\r\n      },\r\n      "Action": "sts:AssumeRole",\r\n      "Condition": {\r\n        "StringEquals": {\r\n          "aws:SourceAccount": "225774417763"\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:"And Permission Policy:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "Version": "2012-10-17",\r\n  "Statement": [\r\n    {\r\n      "Sid": "CreateNetworkInterface",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "ec2:CreateNetworkInterface",\r\n        "ec2:DeleteNetworkInterface",\r\n        "ec2:ModifyNetworkInterfaceAttribute"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:ec2:*:225774417763:network-interface/*",\r\n        "arn:aws:ec2:*:225774417763:instance/*",\r\n        "arn:aws:ec2:*:225774417763:subnet/*",\r\n        "arn:aws:ec2:*:225774417763:security-group/*"\r\n      ]\r\n    },\r\n    {\r\n      "Sid": "DescribeVPC",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "ec2:DescribeAvailabilityZones",\r\n        "ec2:DescribeInternetGateways",\r\n        "ec2:DescribeSubnets",\r\n        "ec2:DescribeVpcs",\r\n        "ec2:DescribeSecurityGroups",\r\n        "ec2:DescribeDhcpOptions",\r\n        "ec2:DescribeNetworkInterfaces"\r\n      ],\r\n      "Resource": "*"\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"data-providers",children:"Data Providers"}),"\n",(0,s.jsx)(r.h3,{id:"creating-the-secrets-for-accessing-db",children:"Creating the secrets for accessing DB"}),"\n",(0,s.jsxs)(r.p,{children:["On ",(0,s.jsx)(r.code,{children:"Secret Manager"})," you need to create 2 secrets to access the DB"]}),"\n",(0,s.jsx)(r.h3,{id:"accessing-the-secrets",children:"Accessing the secrets"}),"\n",(0,s.jsx)(r.p,{children:"Make sure your DMN role has such permission policy:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "Version": "2012-10-17",\r\n  "Statement": [\r\n    {\r\n      "Sid": "AllowDMSSecretsManagerWithKMSRole",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "secretsmanager:DescribeSecret",\r\n        "secretsmanager:GetSecretValue"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:secretsmanager:us-east-1:225774417763:secret:jumpbox-g2sentry-dev-db-4qfB88"\r\n      ]\r\n    },\r\n    {\r\n      "Sid": "KMS",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "kms:Encrypt",\r\n        "kms:ReEncryptFrom",\r\n        "kms:ReEncryptTo",\r\n        "kms:Decrypt"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:kms:us-east-1:225774417763:key/*"\r\n      ],\r\n      "Condition": {\r\n        "StringEquals": {\r\n          "kms:CallerAccount": "225774417763",\r\n          "kms:ViaService": [\r\n            "secretsmanager.us-east-1.amazonaws.com"\r\n          ],\r\n          "kms:EncryptionContext:SecretARN": [\r\n            "arn:aws:secretsmanager:us-east-1:225774417763:secret:jumpbox-g2sentry-dev-db-4qfB88"\r\n          ]\r\n        }\r\n      }\r\n    },\r\n    {\r\n      "Sid": "KMSDescribeKey",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "kms:DescribeKey"\r\n      ],\r\n      "Resource": [\r\n        "arn:aws:kms:us-east-1:225774417763:key/*"\r\n      ],\r\n      "Condition": {\r\n        "StringEquals": {\r\n          "kms:CallerAccount": "225774417763",\r\n          "kms:ViaService": "secretsmanager.us-east-1.amazonaws.com"\r\n        }\r\n      }\r\n    },\r\n    {\r\n      "Sid": "KMSListAliases",\r\n      "Effect": "Allow",\r\n      "Action": [\r\n        "kms:ListAliases"\r\n      ],\r\n      "Resource": "*"\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"used-services",children:"Used services"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"security groups"}),"\n",(0,s.jsx)(r.li,{children:"roles"}),"\n",(0,s.jsx)(r.li,{children:"policies"}),"\n",(0,s.jsx)(r.li,{children:"VM"}),"\n",(0,s.jsxs)(r.li,{children:["DMS","\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"collectors"}),"\n",(0,s.jsx)(r.li,{children:"providers"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(r.li,{children:"s3"}),"\n",(0,s.jsx)(r.li,{children:"secrets manager"}),"\n",(0,s.jsx)(r.li,{}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>a});var s=n(6540);const t={},c=s.createContext(t);function i(e){const r=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(c.Provider,{value:r},e.children)}}}]);